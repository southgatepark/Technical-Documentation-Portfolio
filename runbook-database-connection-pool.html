<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troubleshooting Runbook: Database Connection Pool Exhaustion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0e27;
            --bg-card: #0f1535;
            --bg-elevated: #1a2142;
            --text: #e8eaed;
            --text-secondary: #9aa0a6;
            --accent: #4fc3f7;
            --success: #66bb6a;
            --warning: #ffa726;
            --danger: #ef5350;
            --info: #5c6bc0;
            --border: #2a3453;
        }

        body {
            font-family: 'Roboto', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, #ef5350 0%, #ff7043 100%);
            color: white;
            padding: 20px 40px;
            text-align: center;
            font-weight: 500;
            font-size: 15px;
            box-shadow: 0 4px 12px rgba(239, 83, 80, 0.3);
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 3px solid var(--danger);
            padding: 40px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .severity-badge {
            display: inline-block;
            padding: 8px 20px;
            background: var(--danger);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 15px;
        }

        .severity-high {
            background: var(--danger);
        }

        .severity-medium {
            background: var(--warning);
        }

        .severity-low {
            background: var(--info);
        }

        h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .header-meta {
            display: flex;
            gap: 40px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .meta-icon {
            font-size: 20px;
        }

        /* Quick Actions */
        .quick-actions {
            background: var(--bg-elevated);
            padding: 25px;
            margin: 30px 0;
            border-radius: 12px;
            border: 2px solid var(--accent);
        }

        .quick-actions h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .action-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .action-btn-secondary {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .action-btn-secondary:hover {
            background: var(--accent);
            color: var(--bg);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }

        /* Section */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 35px;
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 28px;
            margin-bottom: 25px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-icon {
            font-size: 32px;
        }

        h3 {
            font-size: 20px;
            margin: 25px 0 15px;
            color: var(--text);
        }

        p {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.7;
        }

        /* Step-by-step */
        .steps {
            counter-reset: step-counter;
            list-style: none;
            margin: 25px 0;
        }

        .step {
            counter-increment: step-counter;
            position: relative;
            padding: 25px 25px 25px 75px;
            background: var(--bg-elevated);
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .step::before {
            content: counter(step-counter);
            position: absolute;
            left: 20px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: var(--accent);
            color: var(--bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text);
        }

        .step-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Code Block */
        .code-block {
            background: #000000;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            line-height: 1.7;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .code-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .copy-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--accent);
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent);
            color: var(--bg);
        }

        pre {
            color: #e8eaed;
            margin: 0;
        }

        .code-comment {
            color: #5c6bc0;
        }

        .code-string {
            color: #66bb6a;
        }

        .code-command {
            color: #4fc3f7;
        }

        /* Alert Boxes */
        .alert {
            padding: 20px 24px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid;
        }

        .alert-warning {
            background: rgba(255, 167, 38, 0.15);
            border-color: var(--warning);
        }

        .alert-danger {
            background: rgba(239, 83, 80, 0.15);
            border-color: var(--danger);
        }

        .alert-info {
            background: rgba(79, 195, 247, 0.15);
            border-color: var(--accent);
        }

        .alert-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-warning .alert-title {
            color: var(--warning);
        }

        .alert-danger .alert-title {
            color: var(--danger);
        }

        .alert-info .alert-title {
            color: var(--accent);
        }

        .alert p {
            font-size: 14px;
            margin: 0;
        }

        /* Metrics */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .metric-card {
            background: var(--bg-elevated);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--danger);
            font-family: 'Roboto Mono', monospace;
        }

        .metric-trend {
            font-size: 12px;
            color: var(--danger);
            margin-top: 5px;
        }

        /* Checklist */
        .checklist {
            list-style: none;
            margin: 20px 0;
        }

        .checklist li {
            padding: 12px 12px 12px 45px;
            margin-bottom: 10px;
            background: var(--bg-elevated);
            border-radius: 6px;
            position: relative;
            color: var(--text-secondary);
        }

        .checklist li::before {
            content: '‚ñ°';
            position: absolute;
            left: 15px;
            font-size: 20px;
            color: var(--accent);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header {
                padding: 25px 20px;
            }

            h1 {
                font-size: 32px;
            }

            .section {
                padding: 25px 20px;
            }

            .step {
                padding-left: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="alert-banner">
        üö® CRITICAL INCIDENT - Database Connection Pool Exhaustion Detected
    </div>

    <header class="header">
        <div class="header-content">
            <span class="severity-badge severity-high">Severity: High</span>
            <h1>Database Connection Pool Exhaustion</h1>
            <div class="header-meta">
                <div class="meta-item">
                    <span class="meta-icon">‚è±Ô∏è</span>
                    <span><strong>MTTR:</strong> 15-30 minutes</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">üë•</span>
                    <span><strong>On-Call:</strong> Backend Team</span>
                </div>
                <div class="meta-item">
                    <span class="meta-icon">üì±</span>
                    <span><strong>Escalation:</strong> Page SRE Lead if unresolved after 20min</span>
                </div>
            </div>

            <div class="quick-actions">
                <h3>‚ö° Immediate Actions</h3>
                <div class="action-buttons">
                    <a href="#" class="action-btn">Increase Pool Size</a>
                    <a href="#" class="action-btn">Restart App Servers</a>
                    <a href="#" class="action-btn-secondary">View Metrics Dashboard</a>
                    <a href="#" class="action-btn-secondary">Check Status Page</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Symptoms -->
        <section class="section">
            <h2><span class="section-icon">üîç</span> Symptoms</h2>
            <p>You'll typically observe the following indicators when connection pool exhaustion occurs:</p>
            
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-label">Error Rate</div>
                    <div class="metric-value">45%</div>
                    <div class="metric-trend">‚Üë 2000% from baseline</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Response Time</div>
                    <div class="metric-value">8.5s</div>
                    <div class="metric-trend">‚Üë 1200% from baseline</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Connections</div>
                    <div class="metric-value">100/100</div>
                    <div class="metric-trend">Pool exhausted</div>
                </div>
            </div>

            <h3>Application Errors</h3>
            <div class="code-block">
                <div class="code-header">
                    <span class="code-label">Typical Error Message</span>
                </div>
                <pre>Error: Unable to acquire database connection from pool
  at ConnectionPool.acquire (pool.js:145:15)
  at Database.query (database.js:89:24)
  
Caused by: TimeoutError: Connection pool request timed out
  Pool stats: { total: 100, active: 100, idle: 0, waiting: 47 }</pre>
            </div>

            <h3>Monitoring Alerts</h3>
            <ul class="checklist">
                <li>Datadog alert: "Database connection pool utilization > 90%"</li>
                <li>PagerDuty page: "High database connection pool saturation"</li>
                <li>Application logs showing connection timeout errors</li>
                <li>User reports of slow page loads or timeouts</li>
            </ul>
        </section>

        <!-- Impact -->
        <section class="section">
            <h2><span class="section-icon">üí•</span> Impact</h2>
            <div class="alert alert-danger">
                <div class="alert-title">‚ö†Ô∏è Critical User Impact</div>
                <p>
                    Users experience severe degradation in application performance, including failed requests, 
                    timeouts, and inability to complete transactions. This affects all services dependent on 
                    the primary database.
                </p>
            </div>

            <h3>Affected Services</h3>
            <ul style="color: var(--text-secondary); margin-left: 30px;">
                <li>Web application (100% affected)</li>
                <li>Mobile API (100% affected)</li>
                <li>Background job processors (partial)</li>
                <li>Real-time notification service (partial)</li>
            </ul>
        </section>

        <!-- Diagnosis -->
        <section class="section">
            <h2><span class="section-icon">üî¨</span> Diagnosis Steps</h2>
            <p>Follow these steps in order to confirm the issue and identify the root cause:</p>

            <ol class="steps">
                <li class="step">
                    <div class="step-title">Check Connection Pool Metrics</div>
                    <div class="step-content">
                        <p>View the connection pool dashboard to confirm exhaustion.</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-label">Datadog Query</span>
                                <button class="copy-btn">Copy</button>
                            </div>
                            <pre>avg:postgres.connections.active{service:api-production}
avg:postgres.connections.idle{service:api-production}
avg:postgres.connections.waiting{service:api-production}</pre>
                        </div>
                        <p><strong>Expected Result:</strong> Active connections at or near pool maximum (default 100)</p>
                    </div>
                </li>

                <li class="step">
                    <div class="step-title">Identify Long-Running Queries</div>
                    <div class="step-content">
                        <p>Check for queries holding connections for extended periods.</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-label">PostgreSQL Query</span>
                                <button class="copy-btn">Copy</button>
                            </div>
                            <pre><span class="code-command">SELECT</span> 
  pid,
  now() - pg_stat_activity.query_start <span class="code-command">AS</span> duration,
  query,
  state
<span class="code-command">FROM</span> pg_stat_activity
<span class="code-command">WHERE</span> state != <span class="code-string">'idle'</span>
  <span class="code-command">AND</span> now() - pg_stat_activity.query_start > interval <span class="code-string">'5 minutes'</span>
<span class="code-command">ORDER BY</span> duration <span class="code-command">DESC</span>;</pre>
                        </div>
                    </div>
                </li>

                <li class="step">
                    <div class="step-title">Check for Connection Leaks</div>
                    <div class="step-content">
                        <p>Review application logs for connections not properly released.</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-label">kubectl logs command</span>
                                <button class="copy-btn">Copy</button>
                            </div>
                            <pre>kubectl logs -n production -l app=api-server \
  --tail=1000 | grep -E <span class="code-string">"connection.*not.*released|leaked"</span></pre>
                        </div>
                    </div>
                </li>

                <li class="step">
                    <div class="step-title">Analyze Traffic Patterns</div>
                    <div class="step-content">
                        <p>Check if there's a sudden traffic spike causing the issue.</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-label">Check request rate</span>
                            </div>
                            <pre>sum:http.requests{service:api-production}.as_rate()</pre>
                        </div>
                        <p><strong>Normal Rate:</strong> 2,000-5,000 req/min | <strong>Alert Threshold:</strong> > 10,000 req/min</p>
                    </div>
                </li>
            </ol>
        </section>

        <!-- Resolution -->
        <section class="section">
            <h2><span class="section-icon">üîß</span> Resolution Steps</h2>
            
            <div class="alert alert-info">
                <div class="alert-title">‚ÑπÔ∏è Before You Begin</div>
                <p>
                    Document your actions in the incident Slack channel (#incidents) and update the status page. 
                    If resolution takes longer than 20 minutes, escalate to SRE Lead.
                </p>
            </div>

            <h3>Immediate Mitigation (Choose One)</h3>

            <ol class="steps">
                <li class="step">
                    <div class="step-title">Option A: Increase Pool Size (Recommended)</div>
                    <div class="step-content">
                        <p>Temporarily increase the connection pool size to handle current load.</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-label">Update Environment Variable</span>
                                <button class="copy-btn">Copy</button>
                            </div>
                            <pre><span class="code-comment"># Update via kubectl</span>
kubectl set env deployment/api-server \
  -n production \
  DATABASE_POOL_MAX=150

<span class="code-comment"># Verify rollout</span>
kubectl rollout status deployment/api-server -n production</pre>
                        </div>
                        <div class="alert alert-warning" style="margin-top: 15px;">
                            <div class="alert-title">‚ö†Ô∏è Warning</div>
                            <p>
                                Do not exceed 200 connections without consulting DBA. Database has max_connections=200.
                            </p>
                        </div>
                    </div>
                </li>

                <li class="step">
                    <div class="step-title">Option B: Kill Long-Running Queries</div>
                    <div class="step-content">
                        <p>Terminate queries that have been running for more than 10 minutes.</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-label">PostgreSQL</span>
                                <button class="copy-btn">Copy</button>
                            </div>
                            <pre><span class="code-comment">-- Kill specific query by PID</span>
<span class="code-command">SELECT</span> pg_terminate_backend(12345);

<span class="code-comment">-- Kill all queries over 10 minutes (use with caution)</span>
<span class="code-command">SELECT</span> pg_terminate_backend(pid)
<span class="code-command">FROM</span> pg_stat_activity
<span class="code-command">WHERE</span> now() - query_start > interval <span class="code-string">'10 minutes'</span>
  <span class="code-command">AND</span> state != <span class="code-string">'idle'</span>
  <span class="code-command">AND</span> pid != pg_backend_pid();</pre>
                        </div>
                    </div>
                </li>

                <li class="step">
                    <div class="step-title">Option C: Restart Application Servers</div>
                    <div class="step-content">
                        <p>Rolling restart to clear leaked connections (last resort).</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-label">Kubernetes</span>
                                <button class="copy-btn">Copy</button>
                            </div>
                            <pre>kubectl rollout restart deployment/api-server -n production

<span class="code-comment"># Monitor the rollout</span>
kubectl rollout status deployment/api-server -n production -w</pre>
                        </div>
                        <div class="alert alert-danger" style="margin-top: 15px;">
                            <div class="alert-title">‚ö†Ô∏è Caution</div>
                            <p>
                                This causes brief service disruption during pod replacement. Ensure health checks 
                                are working properly before proceeding.
                            </p>
                        </div>
                    </div>
                </li>
            </ol>

            <h3>Verify Resolution</h3>
            <ul class="checklist">
                <li>Connection pool utilization drops below 80%</li>
                <li>Error rate returns to baseline (&lt; 1%)</li>
                <li>Response time returns to normal (&lt; 500ms p95)</li>
                <li>No connection timeout errors in logs for 5 minutes</li>
                <li>Status page updated to "All Systems Operational"</li>
            </ul>
        </section>

        <!-- Root Cause Analysis -->
        <section class="section">
            <h2><span class="section-icon">üéØ</span> Common Root Causes</h2>
            
            <h3>1. Connection Leaks in Application Code</h3>
            <p>
                <strong>Symptom:</strong> Gradual increase in active connections over time<br>
                <strong>Solution:</strong> Review recent code changes for missing connection.release() calls. 
                Use connection pool monitoring to identify which service is leaking.
            </p>

            <h3>2. Traffic Spike from Marketing Campaign</h3>
            <p>
                <strong>Symptom:</strong> Sudden increase in request rate<br>
                <strong>Solution:</strong> Coordinate with marketing team. Implement rate limiting. 
                Increase capacity proactively for planned campaigns.
            </p>

            <h3>3. Slow Query Performance</h3>
            <p>
                <strong>Symptom:</strong> Queries taking longer than usual, blocking connection return<br>
                <strong>Solution:</strong> Analyze query plans. Add missing indexes. Optimize N+1 queries. 
                Consider query caching.
            </p>

            <h3>4. Database CPU/Memory Saturation</h3>
            <p>
                <strong>Symptom:</strong> All queries slow, not just specific ones<br>
                <strong>Solution:</strong> Scale database vertically or horizontally. Check for lock contention. 
                Review recent schema changes.
            </p>
        </section>

        <!-- Prevention -->
        <section class="section">
            <h2><span class="section-icon">üõ°Ô∏è</span> Prevention</h2>
            
            <h3>Monitoring & Alerts</h3>
            <ul style="color: var(--text-secondary); margin: 15px 0 15px 30px;">
                <li>Set up alerts for pool utilization > 80% (warning) and > 90% (critical)</li>
                <li>Monitor query execution time with p95 > 1s threshold</li>
                <li>Track connection leak rate (connections not released within timeout)</li>
                <li>Alert on database CPU > 70% for more than 5 minutes</li>
            </ul>

            <h3>Code Review Checklist</h3>
            <ul class="checklist">
                <li>All database queries use try/finally blocks to ensure connection release</li>
                <li>No queries in loops without batch optimization</li>
                <li>Connection timeout configured (default 30s)</li>
                <li>Query timeout configured (default 60s)</li>
                <li>Proper error handling for database failures</li>
            </ul>

            <h3>Capacity Planning</h3>
            <p>
                Review connection pool sizing monthly. Formula: <code>pool_size = (db_max_connections √ó 0.8) / num_app_instances</code>
            </p>
            <p>
                For our setup: <code>(200 √ó 0.8) / 2 = 80 connections per instance</code> (current: 100)
            </p>
        </section>

        <!-- Related Documentation -->
        <section class="section">
            <h2><span class="section-icon">üìö</span> Related Documentation</h2>
            <ul style="color: var(--text-secondary); margin-left: 30px;">
                <li><a href="#" style="color: var(--accent);">Database Connection Pool Configuration Guide</a></li>
                <li><a href="#" style="color: var(--accent);">PostgreSQL Performance Tuning</a></li>
                <li><a href="#" style="color: var(--accent);">Incident Response Procedures</a></li>
                <li><a href="#" style="color: var(--accent);">Escalation Matrix</a></li>
                <li><a href="#" style="color: var(--accent);">Post-Incident Review Template</a></li>
            </ul>
        </section>
    </div>
</body>
</html>
